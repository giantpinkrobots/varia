name: Build for macOS

on:
  workflow_dispatch:

jobs:
  build-distributable:
    strategy:
      matrix:
        arch: [arm64, x86_64]
    runs-on: macos-14

    env:
      MAC_ARCH: ${{ matrix.arch }}
      DEPS_DIR: ${{ github.workspace }}/mac/dependencies

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          mkdir -p "$DEPS_DIR"

      - name: Install build dependencies
        run: |
          brew update
          brew install automake autoconf libtool pkg-config nasm yasm cmake ninja gtk4 libadwaita python3 lame opus libvorbis libogg gnutls pygobject3 create-dmg
          python3 -m pip install --break-system-packages pillow pygobject yt-dlp pyinstaller aria2p pystray emoji-country-flag

      - name: Build aria2 for ${{ matrix.arch }}
        run: |
          git clone https://github.com/aria2/aria2.git
          cd aria2
          autoreconf -i

          if [ "$MAC_ARCH" = "arm64" ]; then
            HOST="aarch64-apple-darwin"
          else
            HOST="x86_64-apple-darwin"
          fi

          ./configure \
            --host="$HOST" \
            --prefix=$PWD/out

          make -j$(sysctl -n hw.ncpu)
          make install

          mv out/bin/aria2c "$DEPS_DIR/"

      - name: Download binaries
        run: |
          if [ "$MAC_ARCH" = "arm64" ]; then
            DENOURL="https://github.com/denoland/deno/releases/latest/download/deno-aarch64-apple-darwin.zip"
            FFMPEGURL="https://ffmpeg.martin-riedl.de/download/macos/arm64/1756401489_8.0/ffmpeg.zip"
            FFPROBEURL="https://ffmpeg.martin-riedl.de/download/macos/arm64/1756401489_8.0/ffprobe.zip"
          else
            DENOURL="https://github.com/denoland/deno/releases/latest/download/deno-x86_64-apple-darwin.zip"
            FFMPEGURL="https://ffmpeg.martin-riedl.de/download/macos/amd64/1756407576_8.0/ffmpeg.zip"
            FFPROBEURL="https://ffmpeg.martin-riedl.de/download/macos/amd64/1756407576_8.0/ffprobe.zip"
          fi

          # FFmpeg and FFprobe
          curl -fsSL "$FFMPEGURL" -o ffmpeg.zip
          curl -fsSL "$FFPROBEURL" -o ffprobe.zip
          unzip ffmpeg.zip -d "$DEPS_DIR"
          unzip ffprobe.zip -d "$DEPS_DIR"
          rm ffmpeg.zip ffprobe.zip

          # 7zz
          curl -fsSL "https://www.7-zip.org/a/7z2501-mac.tar.xz" -o 7z.tar.xz
          tar -xJf 7z.tar.xz
          rm 7z.tar.xz

          mv 7zz "$DEPS_DIR/7zz"
          
          # Deno
          cd "$DEPS_DIR"

          curl -fsSL "$DENOURL" -o deno.zip
          unzip deno.zip
          rm deno.zip

      - name: Run build.sh for ${{ matrix.arch }}
        run: |
          cd mac
          chmod +x build.sh
          ./build.sh "$DEPS_DIR/.."

      - name: Upload DMG for ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: Varia-${{ matrix.arch }}
          path: mac/Varia-${{ matrix.arch }}.dmg
